<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Ashion Template">
    <meta name="keywords" content="Ashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Zazzle</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/css/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/css/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="/css/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/css/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<% var username=username || '' ; %>
    <% if (username) { %>
        <%-include('../partials/userheader',{username})-%>

            <% }else{%>
                <%-include('../partials/userheader')-%>
                    <%  }  %>
                        <!-- Header Section End -->

                        <!-- Breadcrumb Begin -->
                          <!-- Offcanvas Menu Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
        <div class="offcanvas__close">+</div>
        <ul class="offcanvas__widget">
            <li><span class="icon_search search-switch"></span></li>
            <li>
              <a href="/wishlist"
                ><span class="icon_heart_alt">   </span>
                <% if(username && wishListCount) {%>
                  <div class="tip"> 
                  <span class="wishlist-count" id="wishListCount">
                      <%= wishListCount %>
                  </span> 
                  </div>
                  <% } %>
              </a>  
            </li>
            <li>
              <a href="/shop-cart"
                ><span class="icon_bag_alt"></span>
                <% if (username && cartCount) { %>
                <div class="tip">     
                    <span class="wishlist-count" id="wishListCount">
                        <%= cartCount %>
                    </span>  
                </div>
                <% } %>
              </a>
            </li>
        </ul>
        <div class="offcanvas__logo">
            <a href="./index.html"><img src="img/logo.png" alt=""></a>
        </div>
        <div id="mobile-menu-wrap"></div>
        <div class="offcanvas__auth">
            <% var username=username || '' ; %> 
              <% if (username) { %>
              <a href="/profile"><span class="text-dark font-weight-bold text-center mr-3">
                <%= username %></a> 
              </span>
              <a href="/logout">Logout</a>
              <% }else{%>
              <a href="/login">Login</a>
              <a href="/signup">Sign up</a>
                  <% } %>
        </div>
    </div>
    <!-- Offcanvas Menu End -->
                        <div class="breadcrumb-option">
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="breadcrumb__links">
                                            <a href="/home"><i class="fa fa-home"></i> Home</a>
                                            <span>Shopping cart</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Breadcrumb End -->

                        <!-- Shop Cart Section Begin -->
                        <section class="shop-cart spad">
                            <div class="container">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="shop__cart__table">
                                            <% if (Cart || Cart!=null) { %>


                                                <% if (Cart.products !='' ) { %>
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>PRODUCT</th>
                                                                <!-- <th>name</th> -->
                                                                <th>PRICE</th>
                                                                <th>QUANTITY</th>
                                                                <th>TOTAL</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>

                                                            <%product.forEach(function(product){ %>

                                                                <tr>
                                                                    <td class="cart__product__item">
                                                                        <div
                                                                            class="col-lg-4 col-sm-4 col-8 flex-grow-1 col-name">
                                                                            <div class="left">
                                                                                <% if (
                                                                                    product.productId.productimage.length>
                                                                                    0) { %>
                                                                                    <img src="/uploads/<%= product.productId.productimage[0] %>"
                                                                                        class="img-sm img-thumbnail"
                                                                                        alt="Product Image">
                                                                                    <% } else { %>
                                                                                        <img src="/uploads/default-image.jpg"
                                                                                            alt="Default Image">
                                                                                                 <% } %>

                                                                            </div>

                                                                        </div>
                                                                        <div class="cart__product__item__title">
                                                                            <h6>
                                                                                <%=product.productId.productname%>
                                                                            </h6>
                                                                        </div>
                                                                    </td>

                                                                    <td class="cart__price">&#x20B9;<span
                                                                            id="productprice">
                                                                            <%=product.productId.productpromotionalprice%>
                                                                        </span>
                                                                    </td>
                                                                    <td class="cart__quantity">
                                                                        <!-- <div class="pro-qty">
                                            <input type="text" value="">
                                        </div> -->
                                                                        <div class="cart-product-quantity">
                                                                            <button class="cart-item-count"
                                                                                style="border: none;border-radius:3px; padding:0 16px 0 16px"
                                                                                onclick="changeQuantity('<%=product.productId._id%>','<%=Cart._id%>',-1)">-</button>
                                                                            <span id="<%=product.productId._id%>">
                                                                                <%= product.quantity %>
                                                                            </span>

                                                                            <button class="cart-item-count"
                                                                                style="border: none;border-radius:3px; padding:0 16px 0 16px"
                                                                                onclick="changeQuantity('<%=product.productId._id%>','<%=Cart._id%>',1)">+</button>


                                                                    </td>
                                                                    <td class="cart__total">&#x20B9;
                                                                        <span id="<%= product.productId._id %>"
                                                                            data-product-id="<%= product.productId._id %>"
                                                                            data-field="promotional-price"
                                                                            data-promotional-price="<%= product.productId.productpromotionalprice %>">
                                                                            <%=
                                                                                product.productId.productpromotionalprice*product.quantity%>
                                                                                         
                                                                        </span>
                                                                    </td>
                                                                    <td class="cart__close"><a
                                                                            onclick="removecartitem('<%=product.productId._id%>')">
                                                                            <span class="icon_close"></span></a></td>
                                        </div>
                                        </tr>

                                        </tbody>
                                        <% }); %>

                                            </table>
                                            <% }else{ %>

                                                <div class="text-center"><img style=" display: block;
                                margin-left: auto;
                                margin-right: auto;
                                width: 50%;" src="img/cart-img.png" alt="cart empty">
                                                    <h4> Cart is empty</h4>
                                                </div>

                                                <% } %>
                                                    <% }else{ %>

                                                        <div class="text-center"><img style=" display: block;
                            margin-left: auto;
                            margin-right: auto;
                            width: 50%;" src="img/cart-img.png" alt="cart empty">
                                                            <h4> Cart is empty</h4>
                                                        </div>

                                                        <% } %>


                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 col-sm-6">
                                    <div class="cart__btn">
                                        <a href="/shop">Continue Shopping</a>
                                    </div>
                                </div>
                                <!-- <div class="col-lg-6 col-md-6 col-sm-6">
                <div class="cart__btn update__btn">
                    <a href="#"><span class="icon_loading"></span> Update cart</a>
                </div>
            </div> -->
                            </div>
                            <div class="row">
                                <div class="col-lg-6">

                                </div>
                                <% if(total>0){%>
                                    <div class="col-lg-4 offset-lg-2">
                                        <div class="cart__total__procced">
                                            <h6>Cart total</h6>
                                            <ul>

                                                <li>Total <span id="total">&#x20B9;<%=total%> </span></li>
                                            </ul>
                                            <a href="/checkout" class="primary-btn">Proceed to checkout</a>
                                        </div>
                                    </div>
                                    <%}%>
                            </div>
                            </div>
                        </section>

                        <%-include('../partials/userfooter')-%>
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                            <script>
                                function changeQuantity(proId, cartId, count) {
                                    let quantity = parseInt(document.getElementById(proId).innerHTML);
                                    count = parseInt(count);

                                    $.ajax({
                                        url: '/changeQuantity',
                                        data: {
                                            cart: cartId,
                                            product: proId,
                                            count: count,
                                            quantity: quantity
                                        },
                                        method: 'post',
                                        success: (response) => {
                                            if (response.response.remove) {
                                                Swal.fire("deleted!", "Product has been deleted.", "success").then(
                                                    (res) => {
                                                        window.location.reload();
                                                    }
                                                );
                                                // location.reload();
                                            }
                                            else if (response.response.limit) {
                                                console.log("fff");
                                                Swal.fire(
                                                    "Stock limit!",
                                                    "product not available more quantity.",
                                                    "warning"
                                                )
                                            } else {
                                                quantity += count;
                                                document.getElementById(proId).innerHTML = quantity;
                                                updatePromotionalPrice(proId, quantity, response.total);
                                            }
                                        }
                                    });
                                }

                                function updatePromotionalPrice(proId, quantity, total) {
                                    const promotionalPriceElement = document.querySelector(`span[data-product-id="${proId}"][data-field="promotional-price"]`);
                                    if (promotionalPriceElement) {
                                        const productPromotionalPrice = parseFloat(promotionalPriceElement.dataset.promotionalPrice);
                                        const updatedPromotionalPrice = productPromotionalPrice * quantity;
                                        promotionalPriceElement.textContent = updatedPromotionalPrice.toFixed(2);
                                        document.getElementById('total').innerHTML = total;

                                    }
                                }



                                function removecartitem(productId) {
                                    const url2 = `/removecartitem/${productId}`;
                                    Swal.fire({
                                        title: "Are you sure?",
                                        text: "You won't be able to revert this!",
                                        icon: "warning",
                                        showCancelButton: true,
                                        confirmButtonColor: "#3085d6",
                                        cancelButtonColor: "#d33",
                                        confirmButtonText: "ok",
                                    }).then(async (result) => {
                                        if (result.isConfirmed) {
                                            try {
                                                const response = await fetch(url2, {
                                                    method: "PUT",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                    },
                                                });
                                                console.log(response);
                                                Swal.fire("deleted!", "Product has been deleted.", "success").then(
                                                    (res) => {
                                                        window.location.reload();
                                                    }
                                                );
                                            } catch (error) {
                                                console.error(`${error.message}`);
                                            }
                                        }
                                    });
                                }



                            </script>